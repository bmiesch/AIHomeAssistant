#!/bin/bash

# Store the script's directory (project root)
PROJECT_ROOT="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# Function to build the Docker images
build_images() {
  echo "Building Docker images..."
  cd "${PROJECT_ROOT}/.docker/compile" && docker-compose build
}

# Function to start the services
restart_services() {
  echo "Restarting services..."
  cd "${PROJECT_ROOT}/.docker/compile" && docker-compose down && docker-compose up -d
}

recompile_code() {
  echo "Recompiling code..."
  cd "${PROJECT_ROOT}/.docker/compile" && docker-compose exec app sh -c "cd /app/build && make clean && make cross"
}

# Check if the images need to be built
if [ "$1" == "build" ]; then
  build_images
fi

# Start the services
restart_services || exit 1

# Recompile the code
recompile_code || exit 1

# Copy the binary from docker container to the project root
cd "${PROJECT_ROOT}/.docker/compile" && docker-compose exec app sh -c "cp -f /app/build/start_arm64 /app/source/start_arm64"